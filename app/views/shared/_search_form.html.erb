<!-- Formulário de Busca Avançada -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-8">
  <div class="mb-4">
    <h2 class="text-xl font-bold text-gray-900 mb-2">Encontre seu imóvel ideal</h2>
    <p class="text-gray-600">Use os filtros abaixo para refinar sua busca</p>
  </div>

  <%= search_form_for @q, url: properties_path, method: :get, local: true, class: "space-y-6" do |f| %>
    <!-- Busca por palavras-chave -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
      <div class="lg:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Buscar por palavras-chave
        </label>
        <%= text_field_tag :keywords, params[:keywords], 
            placeholder: "Ex: vista mar, próximo ao shopping, reformado...", 
            class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>
      <div>
        <%= f.submit "Buscar", class: "w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
      </div>
    </div>

    <!-- Filtros Principais -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Tipo de Imóvel -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Tipo de Imóvel
        </label>
        <%= f.select :property_type_eq, 
            options_for_select([['Todos os tipos', '']] + @property_types.map { |type| [type, type] }, params.dig(:q, :property_type_eq)),
            {}, 
            { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" } %>
      </div>

      <!-- Bairro -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Bairro
        </label>
        <%= f.select :neighborhood_id_eq, 
            options_for_select([['Todos os bairros', '']] + @neighborhoods.map { |n| [n.name, n.id] }, params.dig(:q, :neighborhood_id_eq)),
            {}, 
            { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" } %>
      </div>

      <!-- Quartos -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Quartos
        </label>
        <%= f.select :bedrooms_eq, 
            options_for_select([
              ['Qualquer', ''],
              ['1 quarto', '1'],
              ['2 quartos', '2'], 
              ['3 quartos', '3'],
              ['4 quartos', '4'],
              ['5+ quartos', '5']
            ], params.dig(:q, :bedrooms_eq)),
            {},
            { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" } %>
      </div>

      <!-- Banheiros -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Banheiros
        </label>
        <%= f.select :bathrooms_eq, 
            options_for_select([
              ['Qualquer', ''],
              ['1 banheiro', '1'],
              ['2 banheiros', '2'], 
              ['3 banheiros', '3'],
              ['4+ banheiros', '4']
            ], params.dig(:q, :bathrooms_eq)),
            {},
            { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" } %>
      </div>
    </div>

    <!-- Filtros Avançados (Colapsível) -->
    <div class="border-t pt-4">
      <button type="button" 
              class="flex items-center justify-between w-full text-left text-sm font-medium text-gray-700 hover:text-gray-900"
              onclick="toggleAdvancedFilters()"
              id="advanced-filters-toggle">
        <span>Filtros Avançados</span>
        <svg class="w-5 h-5 transform transition-transform" id="advanced-filters-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      
      <div id="advanced-filters" class="hidden mt-4 space-y-4">
        <!-- Faixa de Preço -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Preço Mínimo
            </label>
            <%= f.number_field :price_gteq, 
                placeholder: "Ex: 300000", 
                class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Preço Máximo  
            </label>
            <%= f.number_field :price_lteq, 
                placeholder: "Ex: 800000", 
                class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
          </div>
        </div>

        <!-- Área e Extras -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Área Mínima (m²)
            </label>
            <%= f.number_field :area_m2_gteq, 
                placeholder: "Ex: 80", 
                class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Vagas de Garagem
            </label>
            <%= f.select :garage_spaces_gteq, 
                options_for_select([
                  ['Qualquer', ''],
                  ['1+ vaga', '1'],
                  ['2+ vagas', '2'],
                  ['3+ vagas', '3']
                ], params.dig(:q, :garage_spaces_gteq)),
                {},
                { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" } %>
          </div>

          <div class="flex items-center pt-8">
            <input type="hidden" name="q[furnished_eq]" value="">
            <%= f.check_box :furnished_eq, 
                { checked: params.dig(:q, :furnished_eq) == '1' }, 
                '1', '' %>
            <label class="ml-2 text-sm text-gray-700">
              Apenas mobilados
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Ações -->
    <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
      <%= f.submit "Aplicar Filtros", 
          class: "bg-indigo-600 text-white py-2 px-6 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
      
      <%= link_to "Limpar Filtros", properties_path, 
          class: "text-center bg-gray-200 text-gray-700 py-2 px-6 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" %>
          
      <div class="text-sm text-gray-500 self-center">
        <% if @search_performed %>
          <strong><%= @total_properties %></strong> imóveis encontrados
        <% else %>
          <strong><%= @total_properties %></strong> imóveis disponíveis
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
function toggleAdvancedFilters() {
  const filters = document.getElementById('advanced-filters');
  const icon = document.getElementById('advanced-filters-icon');
  
  if (filters.classList.contains('hidden')) {
    filters.classList.remove('hidden');
    icon.style.transform = 'rotate(180deg)';
  } else {
    filters.classList.add('hidden');
    icon.style.transform = 'rotate(0deg)';
  }
}

// Mostrar filtros avançados se algum filtro avançado estiver ativo
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const advancedParams = ['price_gteq', 'price_lteq', 'area_m2_gteq', 'garage_spaces_gteq', 'furnished_eq'];
  
  const hasAdvancedFilters = advancedParams.some(param => 
    urlParams.get(`q[${param}]`) && urlParams.get(`q[${param}]`) !== ''
  );
  
  if (hasAdvancedFilters) {
    toggleAdvancedFilters();
  }
});
</script>